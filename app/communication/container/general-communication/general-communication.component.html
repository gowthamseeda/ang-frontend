<gp-overlay-layout [toolTipText]="'COMPANY_NAVIGATION_TREE'"
                   [enableCompanyNavigation]="getEnableCompanyNavigation()">
  <gp-outlet-header header-toolbar>
  </gp-outlet-header>
  <gp-read-only-notification [showMessage]="isTaskPresent | async">
  </gp-read-only-notification>
  <gp-edit-layout logo="contact"
                  title="{{ 'COMMUNICATION' | translate }}">
    
    <!-- DEBUG OUTPUT -->
    <div style="background: #f0f8ff; border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 5px;">
      <h3 style="color: #007bff; margin: 0 0 10px 0;">üîç DEBUG INFO</h3>
      
      <div style="margin-bottom: 10px;">
        <strong>communicationDiffList length:</strong> 
        <span [style.color]="(communicationDiffList && communicationDiffList.length > 0) ? 'green' : 'red'">
          {{ communicationDiffList ? communicationDiffList.length : 0 }}
        </span>
      </div>
      
      <div style="margin-bottom: 10px;">
        <strong>taskRetrieved:</strong> 
        <span [style.color]="taskRetrieved ? 'green' : 'red'">{{ taskRetrieved || false }}</span>
      </div>
      
      <div style="margin-bottom: 10px;">
        <strong>openDataChangeTask:</strong> 
        <span [style.color]="openDataChangeTask ? 'green' : 'red'">
          {{ openDataChangeTask ? 'Present' : 'null' }}
        </span>
        <div *ngIf="openDataChangeTask && openDataChangeTask.taskId" style="font-size: 12px; color: #666;">
          TaskId: {{ openDataChangeTask.taskId }}
        </div>
      </div>
      
      <div style="margin-bottom: 10px;" *ngIf="communicationDiffList?.length > 0">
        <strong>communicationDiffList items:</strong>
        <div *ngFor="let item of communicationDiffList; index as i" style="margin: 5px 0; padding: 5px; background: #f9f9f9; font-size: 12px;">
          <div><strong>Item {{ i + 1 }}:</strong></div>
          <div>BrandId: {{ item.brandId || 'BRANDLESS' }}</div>
          <div>FieldId: {{ item.communicationFieldId }}</div>
          <div>Old: {{ item.diff?.old || 'empty' }}</div>
          <div>New: {{ item.diff?.new || 'empty' }}</div>
        </div>
      </div>
      
      <div style="margin-bottom: 10px;" *ngIf="communicationDiffList?.length === 0 && taskRetrieved">
        <span style="color: orange;"><strong>‚ö†Ô∏è No communication diffs found in task data</strong></span>
      </div>
      
      <div style="margin-bottom: 10px;">
        <strong>brandProductGroupsCommunicationData:</strong>
        <pre style="background: white; padding: 10px; border: 1px solid #ccc; overflow: auto; max-height: 200px;">{{ (brandProductGroupsCommunicationData | async) | json }}</pre>
      </div>
    </div>
    <!-- END DEBUG OUTPUT -->
    
    <gp-edit-section>
      <gp-spoken-language [userIsAuthorizedForOutlet]="userIsAuthorizedForOutlet"
                          (dataChangedManually)="spokenLanguageDataChanged()">
      </gp-spoken-language>
    </gp-edit-section>
    <gp-edit-section>
      <h1>{{ 'COMMUNICATION_CHANNELS' | translate }}</h1>
      <div class="communication-data-container">
        <ng-scrollbar track="all">
          <gp-brand-product-groups-data-table (brandProductGroupsChange)="mergeCommunicationDataOfOutlet($event)"
                                              *ngIf="tableEnabled"
                                              [brandProductGroupColumns]="groupedBrandProductGroups | async"
                                              [brandProductGroupsData]="brandProductGroupsCommunicationData | async"
                                              [isLoading]="isLoadingCommunicationChannels"
                                              [readOnly]="!(isEditable | async)"
                                              [permissions]="['communications.generalcommunicationdata.update']">
            <div *matCellDef="let communicationDataRow"
                 class="data-row">
              <gp-communication-channels (communicationChannelsChange)="upsertCommunicationDataOfOutlet($event,
                                     CommunicationFieldType.STANDARD, communicationDataRow.brandProductGroupIds)"
                                         [communicationChannels]="communicationDataRow.data | standardCommunicationChannels | async"
                                         [readOnly]="!(isUserPermittedFor(communicationDataRow.brandProductGroupIds) | async) || !(isEditable | async)">
              </gp-communication-channels>

              <gp-social-media-channels (communicationChannelsChange)="upsertCommunicationDataOfOutlet($event,
                                    CommunicationFieldType.SOCIAL_MEDIA, communicationDataRow.brandProductGroupIds)"
                                        [readOnly]="!(isUserPermittedFor(communicationDataRow.brandProductGroupIds) | async) || !(isEditable | async)"
                                        [socialMediaChannels]="communicationDataRow.data | socialMediaChannels | async">
              </gp-social-media-channels>
            </div>
          </gp-brand-product-groups-data-table>
        </ng-scrollbar>
      </div>
      <ng-container marginalContent>
        <span>{{ 'MARGINAL_CONTENT_GENERAL_COMMUNICATION_CHANNELS_TEXT' | translate }}</span>
      </ng-container>
    </gp-edit-section>
  </gp-edit-layout>

  <ng-container *gpOnlyForRetail="outletId | async"
                footer-toolbar>
    <gp-task-footer (confirm)="save($event)"
                    (discard)="reset()"
                    *ngIf="isEditable | async"
                    [discardButtonDisabled]="cancelButtonDisabled"
                    [confirmButtonDisabled]="saveButtonDisabled"
                    [type]="Type.DATA_CHANGE">
    </gp-task-footer>
  </ng-container>

  <ng-container *gpNotForRetail
                footer-toolbar>
    <gp-default-edit-actions (cancel)="reset()"
                             (save)="save()"
                             *ngIf="isEditable | async"
                             [cancelButtonDisabled]="cancelButtonDisabled"
                             [saveButtonDisabled]="saveButtonDisabled"
                             footer-toolbar>
    </gp-default-edit-actions>
  </ng-container>

  <ng-container overlay>
    <gp-outlet-tree-navigation gpFxFlex
                               gpFxFlexXsSm="auto"
                               style="display: inline"
                               (outletClicked) = outletNavigationClicked()>
    </gp-outlet-tree-navigation>
  </ng-container>
  <gp-message-on-leave [showMessage]="canDeactivate()"></gp-message-on-leave>
</gp-overlay-layout>
